# 动态配置中心项目详解

## 项目概述

这是一个基于 Spring Boot 的**动态配置中心**项目，主要功能是让应用程序中的配置参数能够在运行时动态更新，无需重启应用。项目使用 Redis 作为配置存储和消息总线，通过注解的方式实现配置的自动注入和热更新。

## 项目结构

```
wrench/
├── pom.xml                                    # 父项目POM文件
├── wrench-starter-dynamic-config-center/      # 动态配置中心核心模块
│   ├── pom.xml
│   └── src/main/java/com/yang/wrench/starter/dynamic/config/center/
│       ├── config/                            # 配置类
│       │   ├── DynamicConfigCenterAutoConfig.java
│       │   ├── DynamicConfigCenterAutoProperties.java
│       │   ├── DynamicConfigCenterRegisterAutoConfig.java
│       │   └── DynamicConfigCenterRegisterAutoConfigProperties.java
│       ├── domain/                            # 领域层
│       │   ├── model/valobj/AttributeVO.java
│       │   └── service/
│       │       ├── DynamicConfigCenterService.java
│       │       └── IDynamicConfigCenterService.java
│       ├── listener/                          # 监听器
│       │   └── DynamicConfigCenterAdjustListener.java
│       └── types/                             # 类型定义
│           ├── annotations/DCCValue.java
│           └── common/Constant.java
└── wrench-test/                               # 测试模块
    ├── pom.xml
    └── src/test/java/com/yang/wrench/test/ApiTest.java
```

## 核心概念解释

### 1. 什么是动态配置中心？

想象一下，你有一个电商网站，其中有一个"商品折扣"的配置。传统方式下，如果要修改折扣从 8 折改为 7 折，你需要：

1. 修改代码
2. 重新编译
3. 重新部署
4. 重启服务器

而动态配置中心可以让你：

1. 在管理界面修改配置
2. 配置立即生效，无需重启

### 2. 核心组件说明

#### 2.1 @DCCValue 注解

```java
@DCCValue("downgradeSwitch:0")
private String downgradeSwitch;
```

- 作用：标记需要动态配置的字段
- 格式：`"配置名:默认值"`
- 示例：`"downgradeSwitch:0"` 表示配置名为`downgradeSwitch`，默认值为`"0"`

#### 2.2 Redis 的作用

- **配置存储**：将配置值存储在 Redis 中
- **消息总线**：当配置变更时，通过 Redis 发布消息通知所有应用实例

## 详细执行流程

### 阶段 1：应用启动时的初始化

#### 1.1 Spring Boot 自动配置加载

```
Spring Boot启动
    ↓
读取META-INF/spring.factories
    ↓
加载DynamicConfigCenterRegisterAutoConfig
    ↓
加载DynamicConfigCenterAutoConfig
```

#### 1.2 Redis 连接初始化

```java
// DynamicConfigCenterRegisterAutoConfig.java
@Bean("WrenchRedissonClient")
public RedissonClient redissonClient() {
    // 创建Redis连接
    // 配置连接参数：host, port, password等
}
```

#### 1.3 配置属性加载

```yaml
# application-dev.yml
wrench:
  config:
    system: test-system # 系统标识
    register:
      host: 127.0.0.1 # Redis地址
      port: 6379 # Redis端口
```

### 阶段 2：Bean 初始化时的配置注入

#### 2.1 BeanPostProcessor 拦截

```java
// DynamicConfigCenterAutoConfig.java
@Override
public Object postProcessAfterInitialization(Object bean, String beanName) {
    // 对每个Bean进行后处理
    return dynamicConfigCenterService.proxyObject(bean);
}
```

#### 2.2 字段扫描和注解处理

```java
// DynamicConfigCenterService.java
public Object proxyObject(Object bean) {
    // 1. 获取Bean的Class对象
    Class<?> targetBeanClass = bean.getClass();

    // 2. 扫描所有字段
    Field[] fields = targetBeanClass.getDeclaredFields();

    // 3. 查找@DCCValue注解的字段
    for (Field field : fields) {
        if (field.isAnnotationPresent(DCCValue.class)) {
            // 处理这个字段...
        }
    }
}
```

#### 2.3 注解解析和配置读取

```java
// 解析注解：@DCCValue("downgradeSwitch:0")
DCCValue dccValue = field.getAnnotation(DCCValue.class);
String value = dccValue.value();  // "downgradeSwitch:0"

// 分割获取配置名和默认值
String[] split = value.split(":");
String attributeName = split[0];  // "downgradeSwitch"
String defaultValue = split[1];   // "0"

// 生成完整配置键
String key = properties.getKey(attributeName);  // "test-system:downgradeSwitch"
```

#### 2.4 Redis 配置读取和字段注入

```java
// 从Redis读取配置
RBucket<String> bucket = redissonClient.getBucket(key);
if (!bucket.isExists()) {
    // 配置不存在，使用默认值并保存到Redis
    bucket.set(defaultValue);
    setValue = defaultValue;
} else {
    // 配置存在，使用Redis中的值
    setValue = bucket.get();
}

// 通过反射设置字段值
field.setAccessible(true);
field.set(targetBeanObject, setValue);
```

### 阶段 3：运行时配置更新

#### 3.1 配置变更触发

```java
// 测试代码中
dynamicConfigCenterRedisTopic.publish(new AttributeVO("downgradeSwitch", "4"));
```

#### 3.2 消息监听和处理

```java
// DynamicConfigCenterAdjustListener.java
@Override
public void onMessage(CharSequence charSequence, AttributeVO attributeVO) {
    // 接收到配置变更消息
    // attributeVO.getAttribute() = "downgradeSwitch"
    // attributeVO.getValue() = "4"

    // 调用服务更新配置
    dynamicConfigCenterService.adjustAttributeValue(attributeVO);
}
```

#### 3.3 配置更新和字段刷新

```java
// DynamicConfigCenterService.java
public void adjustAttributeValue(AttributeVO attributeVO) {
    // 1. 更新Redis中的配置
    String key = properties.getKey(attributeVO.getAttribute());
    RBucket<String> bucket = redissonClient.getBucket(key);
    bucket.set(attributeVO.getValue());

    // 2. 更新Bean中的字段值
    Object objectBean = dccBeamGroup.get(key);
    Field field = objectBeanClass.getDeclaredField(attributeVO.getAttribute());
    field.setAccessible(true);
    field.set(objectBean, attributeVO.getValue());
}
```

## 文件依赖关系图

```mermaid
graph TD
    A[ApiTest.java] --> B[@DCCValue注解]
    A --> C[RTopic消息发布]

    B --> D[DynamicConfigCenterAutoConfig]
    D --> E[DynamicConfigCenterService]

    E --> F[Redis连接]
    E --> G[字段扫描和注入]

    C --> H[DynamicConfigCenterAdjustListener]
    H --> E

    I[application.yml] --> J[DynamicConfigCenterAutoProperties]
    I --> K[DynamicConfigCenterRegisterAutoConfigProperties]

    J --> E
    K --> L[RedissonClient]
    L --> F

    M[spring.factories] --> D
    M --> N[DynamicConfigCenterRegisterAutoConfig]
    N --> L
    N --> E
    N --> H
```

## 关键类的作用

### 1. DynamicConfigCenterRegisterAutoConfig

- **作用**：Spring Boot 自动配置的入口
- **职责**：
  - 创建 Redis 连接
  - 注册配置服务
  - 注册消息监听器
  - 创建消息主题

### 2. DynamicConfigCenterAutoConfig

- **作用**：Bean 后处理器
- **职责**：拦截所有 Bean 的初始化，对带有@DCCValue 注解的字段进行处理

### 3. DynamicConfigCenterService

- **作用**：核心业务逻辑
- **职责**：
  - 扫描字段并注入配置
  - 处理配置更新
  - 管理 Bean 缓存

### 4. DynamicConfigCenterAdjustListener

- **作用**：配置变更监听器
- **职责**：接收 Redis 消息，触发配置更新

## 配置流程示例

### 场景：修改降级开关

1. **初始状态**：

   ```java
   @DCCValue("downgradeSwitch:0")
   private String downgradeSwitch;  // 值为 "0"
   ```

2. **配置存储**：

   ```
   Redis Key: test-system:downgradeSwitch
   Redis Value: "0"
   ```

3. **配置变更**：

   ```java
   // 发布消息
   dynamicConfigCenterRedisTopic.publish(new AttributeVO("downgradeSwitch", "4"));
   ```

4. **自动更新**：
   ```
   Redis Value: "0" → "4"
   Bean字段值: "0" → "4"
   ```

## 使用方式

### 1. 添加依赖

```xml
<dependency>
    <groupId>com.yang.wrench</groupId>
    <artifactId>wrench-starter-dynamic-config-center</artifactId>
    <version>1.0</version>
</dependency>
```

### 2. 配置 Redis 连接

```yaml
wrench:
  config:
    system: your-system-name
    register:
      host: 127.0.0.1
      port: 6379
```

### 3. 使用注解

```java
@DCCValue("your-config:default-value")
private String yourConfig;
```

### 4. 动态更新配置

```java
@Resource
private RTopic dynamicConfigCenterRedisTopic;

// 更新配置
dynamicConfigCenterRedisTopic.publish(new AttributeVO("your-config", "new-value"));
```

## 项目优势

1. **零侵入**：通过注解方式，业务代码无需关心配置来源
2. **热更新**：配置变更立即生效，无需重启应用
3. **统一管理**：所有配置集中在 Redis 中管理
4. **高可用**：支持多实例部署，配置变更会同步到所有实例

## 注意事项

1. **字段访问权限**：使用`getDeclaredFields()`而不是`getFields()`，以支持 private 字段
2. **默认值检查**：使用`StringUtils.isEmpty()`而不是`isBlank()`，避免将"0"误判为空
3. **异常处理**：配置读取失败时会抛出异常，需要做好异常处理
4. **Redis 连接**：确保 Redis 服务可用，否则配置读取会失败

## 总结

这个动态配置中心项目通过 Spring Boot 的自动配置机制、Redis 的存储和消息功能，以及 Java 反射技术，实现了一个简单而强大的配置热更新方案。它让应用程序的配置管理变得更加灵活和高效。
